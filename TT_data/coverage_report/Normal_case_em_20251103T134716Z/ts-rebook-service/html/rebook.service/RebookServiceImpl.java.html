<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RebookServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">rebook.service</a> &gt; <span class="el_source">RebookServiceImpl.java</span></div><h1>RebookServiceImpl.java</h1><pre class="source lang-java linenums">package rebook.service;

import edu.fudan.common.entity.Trip;
import edu.fudan.common.entity.TripAllDetail;
import edu.fudan.common.entity.TripAllDetailInfo;
import edu.fudan.common.entity.TripResponse;
import edu.fudan.common.util.JsonUtils;
import edu.fudan.common.util.Response;
import edu.fudan.common.util.StringUtils;
import org.apache.tomcat.jni.Time;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import edu.fudan.common.entity.*;
import rebook.entity.*;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

/**
 * @author fdse
 */
@Service
<span class="fc" id="L34">public class RebookServiceImpl implements RebookService {</span>

    @Autowired
    private RestTemplate restTemplate;
    @Autowired
    private DiscoveryClient discoveryClient;

<span class="fc" id="L41">    private static final Logger LOGGER = LoggerFactory.getLogger(RebookServiceImpl.class);</span>

    private String getServiceUrl(String serviceName) {
<span class="nc" id="L44">        return &quot;http://&quot; + serviceName;</span>
    }

    @Override
    public Response rebook(RebookInfo info, HttpHeaders httpHeaders) {

<span class="nc" id="L50">        Response&lt;Order&gt; queryOrderResult = getOrderByRebookInfo(info, httpHeaders);</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (queryOrderResult.getStatus() == 1) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (queryOrderResult.getData().getStatus() != 1) {</span>
<span class="nc" id="L54">                RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order not suitable to rebook][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L55">                return new Response&lt;&gt;(0, &quot;you order not suitable to rebook!&quot;, null);</span>
            }
        } else {
<span class="nc" id="L58">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order not found][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L59">            return new Response(0, &quot;order not found&quot;, null);</span>
        }

<span class="nc" id="L62">        Order order = queryOrderResult.getData();</span>
<span class="nc" id="L63">        int status = order.getStatus();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (status == OrderStatus.NOTPAID.getCode()) {</span>
<span class="nc" id="L65">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order not paid][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L66">            return new Response&lt;&gt;(0, &quot;You haven't paid the original ticket!&quot;, null);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        } else if (status == OrderStatus.PAID.getCode()) {</span>
            // do nothing
<span class="nc bnc" id="L69" title="All 2 branches missed.">        } else if (status == OrderStatus.CHANGE.getCode()) {</span>
<span class="nc" id="L70">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order can't change twice][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L71">            return new Response&lt;&gt;(0, &quot;You have already changed your ticket and you can only change one time.&quot;, null);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        } else if (status == OrderStatus.COLLECTED.getCode()) {</span>
<span class="nc" id="L73">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order already collected][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L74">            return new Response&lt;&gt;(0, &quot;You have already collected your ticket and you can change it now.&quot;, null);</span>
        } else {
<span class="nc" id="L76">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order can't change][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L77">            return new Response&lt;&gt;(0, &quot;You can't change your ticket.&quot;, null);</span>
        }

        //Check the current time and the bus time of the old order, and judge whether the ticket can be changed according to the time. The ticket cannot be changed after two hours.
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (!checkTime(order.getTravelDate(), order.getTravelTime())) {</span>
<span class="nc" id="L82">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Order beyond change time][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L83">            return new Response&lt;&gt;(0, &quot;You can only change the ticket before the train start or within 2 hours after the train start.&quot;, null);</span>
        }

        //The departure and destination cannot be changed, only the train number, seat and time can be changed
        //Check the info of seat availability and trains
<span class="nc" id="L88">        TripAllDetailInfo gtdi = new TripAllDetailInfo();</span>
<span class="nc" id="L89">        gtdi.setFrom(order.getFrom());</span>
<span class="nc" id="L90">        gtdi.setTo(order.getTo());</span>
<span class="nc" id="L91">        gtdi.setTravelDate(info.getDate());</span>
<span class="nc" id="L92">        gtdi.setTripId(info.getTripId());</span>
<span class="nc" id="L93">        Response&lt;TripAllDetail&gt; gtdr = getTripAllDetailInformation(gtdi, info.getTripId(), httpHeaders);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (gtdr.getStatus() == 0) {</span>
<span class="nc" id="L95">            RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Trip detail not found][OrderId: {}]&quot;,info.getOrderId());</span>
<span class="nc" id="L96">            return new Response&lt;&gt;(0, gtdr.getMsg(), null);</span>
        } else {
<span class="nc" id="L98">            TripResponse tripResponse = gtdr.getData().getTripResponse();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (tripResponse.getConfortClass() &lt;= 0) {</span>
<span class="nc" id="L101">                    RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Seat Not Enough][OrderId: {},SeatType: {}]&quot;,info.getOrderId(),info.getSeatType());</span>
<span class="nc" id="L102">                    return new Response&lt;&gt;(0, &quot;Seat Not Enough&quot;, null);</span>
                }
            } else {
<span class="nc bnc" id="L105" title="All 4 branches missed.">                if (tripResponse.getEconomyClass() == SeatClass.SECONDCLASS.getCode() &amp;&amp; tripResponse.getConfortClass() &lt;= 0) {</span>
<span class="nc" id="L106">                    RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Seat Not Enough][OrderId: {},SeatType: {}]&quot;,info.getOrderId(),info.getSeatType());</span>
<span class="nc" id="L107">                    return new Response&lt;&gt;(0, &quot;Seat Not Enough&quot;, null);</span>
                }
            }
        }

        //Deal with the difference, more refund less compensation
        //Return the original ticket so that someone else can book the corresponding seat

<span class="nc" id="L115">        String ticketPrice = &quot;0&quot;;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="nc" id="L117">            ticketPrice = ((TripAllDetail) gtdr.getData()).getTripResponse().getPriceForConfortClass();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        } else if (info.getSeatType() == SeatClass.SECONDCLASS.getCode()) {</span>
<span class="nc" id="L119">            ticketPrice = ((TripAllDetail) gtdr.getData()).getTripResponse().getPriceForEconomyClass();</span>
        }
<span class="nc" id="L121">        String oldPrice = order.getPrice();</span>
<span class="nc" id="L122">        BigDecimal priceOld = new BigDecimal(oldPrice);</span>
<span class="nc" id="L123">        BigDecimal priceNew = new BigDecimal(ticketPrice);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (priceOld.compareTo(priceNew) &gt; 0) {</span>
            //Refund the difference
<span class="nc" id="L126">            String difference = priceOld.subtract(priceNew).toString();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (!drawBackMoney(info.getLoginId(), difference, httpHeaders)) {</span>
<span class="nc" id="L128">                RebookServiceImpl.LOGGER.warn(&quot;[rebook][Rebook warn][Can't draw back the difference money][OrderId: {},LoginId: {},difference: {}]&quot;,info.getOrderId(),info.getLoginId(),difference);</span>
<span class="nc" id="L129">                return new Response&lt;&gt;(0, &quot;Can't draw back the difference money, please try again!&quot;, null);</span>
            }
<span class="nc" id="L131">            return updateOrder(order, info, (TripAllDetail) gtdr.getData(), ticketPrice, httpHeaders);</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        } else if (priceOld.compareTo(priceNew) == 0) {</span>
            //do nothing
<span class="nc" id="L135">            return updateOrder(order, info, (TripAllDetail) gtdr.getData(), ticketPrice, httpHeaders);</span>
        } else {
            //make up the difference
<span class="nc" id="L138">            String difference = priceNew.subtract(priceOld).toString();</span>
<span class="nc" id="L139">            Order orderMoneyDifference = new Order();</span>
<span class="nc" id="L140">            orderMoneyDifference.setDifferenceMoney(difference);</span>
<span class="nc" id="L141">            return new Response&lt;&gt;(2, &quot;Please pay the different money!&quot;, orderMoneyDifference);</span>
        }
    }

    @Override
    public Response payDifference(RebookInfo info, HttpHeaders httpHeaders) {

<span class="nc" id="L148">        Response queryOrderResult = getOrderByRebookInfo(info, httpHeaders);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (queryOrderResult.getStatus() == 0) {</span>
<span class="nc" id="L150">            return new Response&lt;&gt;(0, queryOrderResult.getMsg(), null);</span>
        }
<span class="nc" id="L152">        Order order = (Order) queryOrderResult.getData();</span>

<span class="nc" id="L154">        TripAllDetailInfo gtdi = new TripAllDetailInfo();</span>
<span class="nc" id="L155">        gtdi.setFrom(order.getFrom());</span>
<span class="nc" id="L156">        gtdi.setTo(order.getTo());</span>
<span class="nc" id="L157">        gtdi.setTravelDate(info.getDate());</span>
<span class="nc" id="L158">        gtdi.setTripId(info.getTripId());</span>
        // TripAllDetail
<span class="nc" id="L160">        Response gtdrResposne = getTripAllDetailInformation(gtdi, info.getTripId(), httpHeaders);</span>


<span class="nc" id="L163">        TripAllDetail gtdr = (TripAllDetail) gtdrResposne.getData();</span>


<span class="nc" id="L166">        String ticketPrice = &quot;0&quot;;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {</span>
<span class="nc" id="L168">            ticketPrice = gtdr.getTripResponse().getPriceForConfortClass();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (info.getSeatType() == SeatClass.SECONDCLASS.getCode()) {</span>
<span class="nc" id="L170">            ticketPrice = gtdr.getTripResponse().getPriceForEconomyClass();</span>
        }
<span class="nc" id="L172">        String oldPrice = order.getPrice();</span>
<span class="nc" id="L173">        BigDecimal priceOld = new BigDecimal(oldPrice);</span>
<span class="nc" id="L174">        BigDecimal priceNew = new BigDecimal(ticketPrice);</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (payDifferentMoney(info.getOrderId(), info.getTripId(), info.getLoginId(), priceNew.subtract(priceOld).toString(), httpHeaders)) {</span>
<span class="nc" id="L177">            return updateOrder(order, info, gtdr, ticketPrice, httpHeaders);</span>
        } else {
<span class="nc" id="L179">            RebookServiceImpl.LOGGER.warn(&quot;[payDifference][Pay difference warn][Can't pay the difference money][OrderId: {},LoginId: {},TripId: {}]&quot;,info.getOrderId(),info.getLoginId(),info.getTripId());</span>
<span class="nc" id="L180">            return new Response&lt;&gt;(0, &quot;Can't pay the difference,please try again&quot;, null);</span>
        }
    }

    private Response updateOrder(Order order, RebookInfo info, TripAllDetail gtdr, String ticketPrice, HttpHeaders httpHeaders) {

        //4.Modify the original order and set the information of the order
<span class="nc" id="L187">        Trip trip = gtdr.getTrip();</span>
<span class="nc" id="L188">        String oldTripId = order.getTrainNumber();</span>
<span class="nc" id="L189">        order.setTrainNumber(info.getTripId());</span>
<span class="nc" id="L190">        order.setBoughtDate(StringUtils.Date2String(new Date()));</span>
<span class="nc" id="L191">        order.setStatus(OrderStatus.CHANGE.getCode());</span>
<span class="nc" id="L192">        order.setPrice(ticketPrice);//Set ticket price</span>
<span class="nc" id="L193">        order.setSeatClass(info.getSeatType());</span>
<span class="nc" id="L194">        order.setTravelDate(info.getDate());</span>
<span class="nc" id="L195">        order.setTravelTime(trip.getStartTime());</span>

<span class="nc" id="L197">        Route route = getRouteByRouteId(trip.getRouteId(), httpHeaders);</span>
<span class="nc" id="L198">        TrainType trainType = queryTrainTypeByName(trip.getTrainTypeName(), httpHeaders);</span>
<span class="nc" id="L199">        List&lt;String&gt; stations = route.getStations();</span>
<span class="nc" id="L200">        int firstClassTotalNum = trainType.getConfortClass();</span>
<span class="nc" id="L201">        int secondClassTotalNum = trainType.getEconomyClass();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (info.getSeatType() == SeatClass.FIRSTCLASS.getCode()) {//Dispatch the seat</span>
<span class="nc" id="L203">            Ticket ticket =</span>
<span class="nc" id="L204">                    dipatchSeat(info.getDate(),</span>
<span class="nc" id="L205">                            order.getTrainNumber(), order.getFrom(), order.getTo(),</span>
<span class="nc" id="L206">                            SeatClass.FIRSTCLASS.getCode(), firstClassTotalNum, stations, httpHeaders);</span>
<span class="nc" id="L207">            order.setSeatClass(SeatClass.FIRSTCLASS.getCode());</span>
<span class="nc" id="L208">            order.setSeatNumber(&quot;&quot; + ticket.getSeatNo());</span>
<span class="nc" id="L209">        } else {</span>
<span class="nc" id="L210">            Ticket ticket =</span>
<span class="nc" id="L211">                    dipatchSeat(info.getDate(),</span>
<span class="nc" id="L212">                            order.getTrainNumber(), order.getFrom(), order.getTo(),</span>
<span class="nc" id="L213">                            SeatClass.SECONDCLASS.getCode(), secondClassTotalNum, stations, httpHeaders);</span>
<span class="nc" id="L214">            order.setSeatClass(SeatClass.SECONDCLASS.getCode());</span>
<span class="nc" id="L215">            order.setSeatNumber(&quot;&quot; + ticket.getSeatNo());</span>
        }

        //Update order information
        //If the original order and the new order are located in the high-speed train and other orders respectively, the original order should be deleted and created on the other side with a new id.
<span class="nc bnc" id="L220" title="All 8 branches missed.">        if ((tripGD(oldTripId) &amp;&amp; tripGD(info.getTripId())) || (!tripGD(oldTripId) &amp;&amp; !tripGD(info.getTripId()))) {</span>

<span class="nc" id="L222">            Response changeOrderResult = updateOrder(order, info.getTripId(), httpHeaders);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (changeOrderResult.getStatus() == 1) {</span>
<span class="nc" id="L224">                return new Response&lt;&gt;(1, &quot;Success!&quot;, order);</span>
            } else {
<span class="nc" id="L226">                RebookServiceImpl.LOGGER.error(&quot;[updateOrder][Update order error][OrderId: {},TripId: {}]&quot;,info.getOrderId(),info.getTripId());</span>
<span class="nc" id="L227">                return new Response&lt;&gt;(0, &quot;Can't update Order!&quot;, null);</span>
            }
        } else {
            //Delete the original order
<span class="nc" id="L231">            deleteOrder(order.getId().toString(), oldTripId, httpHeaders);</span>
            //Create a new order on the other side
<span class="nc" id="L233">            createOrder(order, order.getTrainNumber(), httpHeaders);</span>
<span class="nc" id="L234">            return new Response&lt;&gt;(1, &quot;Success&quot;, order);</span>
        }
    }

    public Ticket dipatchSeat(String date, String tripId, String startStationId, String endStataionId, int seatType, int tatalNum, List&lt;String&gt; stations, HttpHeaders httpHeaders) {
<span class="nc" id="L239">        Seat seatRequest = new Seat();</span>
<span class="nc" id="L240">        seatRequest.setTravelDate(date);</span>
<span class="nc" id="L241">        seatRequest.setTrainNumber(tripId);</span>
<span class="nc" id="L242">        seatRequest.setSeatType(seatType);</span>
<span class="nc" id="L243">        seatRequest.setStartStation(startStationId);</span>
<span class="nc" id="L244">        seatRequest.setDestStation(endStataionId);</span>
<span class="nc" id="L245">        seatRequest.setTotalNum(tatalNum);</span>
<span class="nc" id="L246">        seatRequest.setStations(stations);</span>

<span class="nc" id="L248">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L249">        HttpEntity requestEntityTicket = new HttpEntity(seatRequest, newHeaders);</span>
<span class="nc" id="L250">        String seat_service_url = getServiceUrl(&quot;ts-seat-service&quot;);</span>
<span class="nc" id="L251">        ResponseEntity&lt;Response&lt;Ticket&gt;&gt; reTicket = restTemplate.exchange(</span>
                seat_service_url + &quot;/api/v1/seatservice/seats&quot;,
                HttpMethod.POST,
                requestEntityTicket,
<span class="nc" id="L255">                new ParameterizedTypeReference&lt;Response&lt;Ticket&gt;&gt;() {</span>
                });
<span class="nc" id="L257">        return reTicket.getBody().getData();</span>
    }


    private boolean tripGD(String tripId) {
<span class="nc bnc" id="L262" title="All 4 branches missed.">        return tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;);</span>
    }

    private boolean checkTime(String travelDate, String travelTime) {
<span class="nc" id="L266">        boolean result = true;</span>
<span class="nc" id="L267">        Calendar calDateA = Calendar.getInstance();</span>
<span class="nc" id="L268">        Date today = new Date();</span>
<span class="nc" id="L269">        calDateA.setTime(today);</span>
<span class="nc" id="L270">        Calendar calDateB = Calendar.getInstance();</span>
<span class="nc" id="L271">        calDateB.setTime(StringUtils.String2Date(travelDate));</span>
<span class="nc" id="L272">        Calendar calDateC = Calendar.getInstance();</span>
<span class="nc" id="L273">        calDateC.setTime(StringUtils.String2Date(travelTime));</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (calDateA.get(Calendar.YEAR) &gt; calDateB.get(Calendar.YEAR)) {</span>
<span class="nc" id="L275">            result = false;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        } else if (calDateA.get(Calendar.YEAR) == calDateB.get(Calendar.YEAR)) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (calDateA.get(Calendar.MONTH) &gt; calDateB.get(Calendar.MONTH)) {</span>
<span class="nc" id="L278">                result = false;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            } else if (calDateA.get(Calendar.MONTH) == calDateB.get(Calendar.MONTH)) {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                if (calDateA.get(Calendar.DAY_OF_MONTH) &gt; calDateB.get(Calendar.DAY_OF_MONTH)) {</span>
<span class="nc" id="L281">                    result = false;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                } else if (calDateA.get(Calendar.DAY_OF_MONTH) == calDateB.get(Calendar.DAY_OF_MONTH)) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                    if (calDateA.get(Calendar.HOUR_OF_DAY) &gt; calDateC.get(Calendar.HOUR_OF_DAY) + 2) {</span>
<span class="nc" id="L284">                        result = false;</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">                    } else if (calDateA.get(Calendar.HOUR_OF_DAY) == (calDateC.get(Calendar.HOUR_OF_DAY) + 2) &amp;&amp; calDateA.get(Calendar.MINUTE) &gt; calDateC.get(Calendar.MINUTE)) {</span>
<span class="nc" id="L286">                        result = false;</span>
                    }
                }
            }
        }
<span class="nc" id="L291">        return result;</span>
    }


    private Response&lt;TripAllDetail&gt; getTripAllDetailInformation(TripAllDetailInfo gtdi, String tripId, HttpHeaders httpHeaders) {
        Response&lt;TripAllDetail&gt; gtdr;
<span class="nc" id="L297">        String requestUrl = &quot;&quot;;</span>
<span class="nc" id="L298">        String travel_service_url = getServiceUrl(&quot;ts-travel-service&quot;);</span>
<span class="nc" id="L299">        String travel2_service_url = getServiceUrl(&quot;ts-travel2-service&quot;);</span>
<span class="nc bnc" id="L300" title="All 4 branches missed.">        if (tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;)) {</span>
<span class="nc" id="L301">            requestUrl = travel_service_url + &quot;/api/v1/travelservice/trip_detail&quot;;</span>
            // ts-travel-service:12346/travel/getTripAllDetailInfo
        } else {
<span class="nc" id="L304">            requestUrl = travel2_service_url + &quot;/api/v1/travel2service/trip_detail&quot;;</span>
            //ts-travel2-service:16346/travel2/getTripAllDetailInfo
        }
<span class="nc" id="L307">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L308">        HttpEntity requestGetTripAllDetailResult = new HttpEntity(gtdi, newHeaders);</span>
<span class="nc" id="L309">        ResponseEntity&lt;Response&lt;TripAllDetail&gt;&gt; reGetTripAllDetailResult = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestGetTripAllDetailResult,
<span class="nc" id="L313">                new ParameterizedTypeReference&lt;Response&lt;TripAllDetail&gt;&gt;() {</span>
                });
<span class="nc" id="L315">        gtdr = reGetTripAllDetailResult.getBody();</span>
<span class="nc" id="L316">        return gtdr;</span>
    }

    private Response createOrder(Order order, String tripId, HttpHeaders httpHeaders) {
<span class="nc" id="L320">        String requestUrl = &quot;&quot;;</span>
<span class="nc" id="L321">        String order_service_url = getServiceUrl(&quot;ts-order-service&quot;);</span>
<span class="nc" id="L322">        String order_other_service_url = getServiceUrl(&quot;ts-order-other-service&quot;);</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">        if (tripId.startsWith(&quot;G&quot;) || tripId.startsWith(&quot;D&quot;)) {</span>
            // ts-order-service:12031/order/create
<span class="nc" id="L325">            requestUrl = order_service_url + &quot;/api/v1/orderservice/order&quot;;</span>
        } else {
            //ts-order-other-service:12032/orderOther/create
<span class="nc" id="L328">            requestUrl = order_other_service_url + &quot;/api/v1/orderOtherService/orderOther&quot;;</span>
        }
<span class="nc" id="L330">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L331">        HttpEntity requestCreateOrder = new HttpEntity(order, newHeaders);</span>
<span class="nc" id="L332">        ResponseEntity&lt;Response&gt; reCreateOrder = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestCreateOrder,
                Response.class);
<span class="nc" id="L337">        return reCreateOrder.getBody();</span>
    }

    private Response updateOrder(Order info, String tripId, HttpHeaders httpHeaders) {
<span class="nc" id="L341">        String requestOrderUtl = &quot;&quot;;</span>
<span class="nc" id="L342">        String order_service_url = getServiceUrl(&quot;ts-order-service&quot;);</span>
<span class="nc" id="L343">        String order_other_service_url = getServiceUrl(&quot;ts-order-other-service&quot;);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (tripGD(tripId)) {</span>
<span class="nc" id="L345">            requestOrderUtl = order_service_url + &quot;/api/v1/orderservice/order&quot;;</span>
        } else {
<span class="nc" id="L347">            requestOrderUtl = order_other_service_url + &quot;/api/v1/orderOtherService/orderOther&quot;;</span>
        }
<span class="nc" id="L349">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L350">        HttpEntity requestUpdateOrder = new HttpEntity(info, newHeaders);</span>
<span class="nc" id="L351">        ResponseEntity&lt;Response&gt; reUpdateOrder = restTemplate.exchange(</span>
                requestOrderUtl,
                HttpMethod.PUT,
                requestUpdateOrder,
                Response.class);
<span class="nc" id="L356">        return reUpdateOrder.getBody();</span>
    }

    private Response deleteOrder(String orderId, String tripId, HttpHeaders httpHeaders) {

<span class="nc" id="L361">        String requestUrl = &quot;&quot;;</span>
<span class="nc" id="L362">        String order_service_url = getServiceUrl(&quot;ts-order-service&quot;);</span>
<span class="nc" id="L363">        String order_other_service_url = getServiceUrl(&quot;ts-order-other-service&quot;);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (tripGD(tripId)) {</span>
<span class="nc" id="L365">            requestUrl = order_service_url + &quot;/api/v1/orderservice/order/&quot; + orderId;</span>
        } else {
<span class="nc" id="L367">            requestUrl = order_other_service_url + &quot;/api/v1/orderOtherService/orderOther/&quot; + orderId;</span>
        }
<span class="nc" id="L369">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L370">        HttpEntity requestDeleteOrder = new HttpEntity(newHeaders);</span>
<span class="nc" id="L371">        ResponseEntity&lt;Response&gt; reDeleteOrder = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.POST,
                requestDeleteOrder,
                Response.class);

<span class="nc" id="L377">        return reDeleteOrder.getBody();</span>
    }

    private Response&lt;Order&gt; getOrderByRebookInfo(RebookInfo info, HttpHeaders httpHeaders) {
        Response&lt;Order&gt; queryOrderResult;
        //Change can only be changed once, check the status of the order to determine whether it has been changed
<span class="nc" id="L383">        String requestUrl = &quot;&quot;;</span>
<span class="nc" id="L384">        String order_service_url = getServiceUrl(&quot;ts-order-service&quot;);</span>
<span class="nc" id="L385">        String order_other_service_url = getServiceUrl(&quot;ts-order-other-service&quot;);</span>
<span class="nc bnc" id="L386" title="All 4 branches missed.">        if (info.getOldTripId().startsWith(&quot;G&quot;) || info.getOldTripId().startsWith(&quot;D&quot;)) {</span>
<span class="nc" id="L387">            requestUrl = order_service_url + &quot;/api/v1/orderservice/order/&quot; + info.getOrderId();</span>
        } else {
<span class="nc" id="L389">            requestUrl = order_other_service_url + &quot;/api/v1/orderOtherService/orderOther/&quot; + info.getOrderId();</span>
        }
<span class="nc" id="L391">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L392">        HttpEntity requestEntityGetOrderByRebookInfo = new HttpEntity(newHeaders);</span>
<span class="nc" id="L393">        ResponseEntity&lt;Response&lt;Order&gt;&gt; reGetOrderByRebookInfo = restTemplate.exchange(</span>
                requestUrl,
                HttpMethod.GET,
                requestEntityGetOrderByRebookInfo,
<span class="nc" id="L397">                new ParameterizedTypeReference&lt;Response&lt;Order&gt;&gt;() {</span>
                });

<span class="nc" id="L400">        queryOrderResult = reGetOrderByRebookInfo.getBody();</span>
<span class="nc" id="L401">        return queryOrderResult;</span>
    }

    public TrainType queryTrainTypeByName(String trainTypeName, HttpHeaders headers) {
<span class="nc" id="L405">        HttpEntity requestEntity = new HttpEntity(null);</span>
<span class="nc" id="L406">        String train_service_url=getServiceUrl(&quot;ts-train-service&quot;);</span>
<span class="nc" id="L407">        ResponseEntity&lt;Response&gt; re = restTemplate.exchange(</span>
                train_service_url + &quot;/api/v1/trainservice/trains/byName/&quot; + trainTypeName,
                HttpMethod.GET,
                requestEntity,
                Response.class);
<span class="nc" id="L412">        Response  response = re.getBody();</span>

<span class="nc" id="L414">        return JsonUtils.conveterObject(response.getData(), TrainType.class);</span>
    }

    private Route getRouteByRouteId(String routeId, HttpHeaders headers) {
<span class="nc" id="L418">        HttpEntity requestEntity = new HttpEntity(null);</span>
<span class="nc" id="L419">        String route_service_url=getServiceUrl(&quot;ts-route-service&quot;);</span>
<span class="nc" id="L420">        ResponseEntity&lt;Response&gt; re = restTemplate.exchange(</span>
                route_service_url + &quot;/api/v1/routeservice/routes/&quot; + routeId,
                HttpMethod.GET,
                requestEntity,
                Response.class);
<span class="nc" id="L425">        Response result = re.getBody();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if ( result.getStatus() == 0) {</span>
<span class="nc" id="L427">            LOGGER.warn(&quot;[getRouteByRouteId][Get Route By Id Failed][Fail msg: {}]&quot;, result.getMsg());</span>
<span class="nc" id="L428">            return null;</span>
        } else {
<span class="nc" id="L430">            LOGGER.info(&quot;[getRouteByRouteId][Get Route By Id][Success]&quot;);</span>
<span class="nc" id="L431">            return JsonUtils.conveterObject(result.getData(), Route.class);</span>
        }
    }

    private boolean payDifferentMoney(String orderId, String tripId, String userId, String money, HttpHeaders httpHeaders) {
<span class="nc" id="L436">        PaymentDifferenceInfo info = new PaymentDifferenceInfo();</span>
<span class="nc" id="L437">        info.setOrderId(orderId);</span>
<span class="nc" id="L438">        info.setTripId(tripId);</span>
<span class="nc" id="L439">        info.setUserId(userId);</span>
<span class="nc" id="L440">        info.setPrice(money);</span>

<span class="nc" id="L442">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L443">        HttpEntity requestEntityPayDifferentMoney = new HttpEntity(info, newHeaders);</span>
<span class="nc" id="L444">        String inside_payment_service_url = getServiceUrl(&quot;ts-inside-payment-service&quot;);</span>
<span class="nc" id="L445">        ResponseEntity&lt;Response&gt; rePayDifferentMoney = restTemplate.exchange(</span>
                inside_payment_service_url + &quot;/api/v1/inside_pay_service/inside_payment/difference&quot;,
                HttpMethod.POST,
                requestEntityPayDifferentMoney,
                Response.class);
<span class="nc" id="L450">        Response result = rePayDifferentMoney.getBody();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        return result.getStatus() == 1;</span>
    }

    private boolean drawBackMoney(String userId, String money, HttpHeaders httpHeaders) {

<span class="nc" id="L456">        HttpHeaders newHeaders = getAuthorizationHeadersFrom(httpHeaders);</span>
<span class="nc" id="L457">        HttpEntity requestEntityDrawBackMoney = new HttpEntity(newHeaders);</span>
<span class="nc" id="L458">        String inside_payment_service_url = getServiceUrl(&quot;ts-inside-payment-service&quot;);</span>
<span class="nc" id="L459">        ResponseEntity&lt;Response&gt; reDrawBackMoney = restTemplate.exchange(</span>
                inside_payment_service_url + &quot;/api/v1/inside_pay_service/inside_payment/drawback/&quot; + userId + &quot;/&quot; + money,
                HttpMethod.GET,
                requestEntityDrawBackMoney,
                Response.class);
<span class="nc" id="L464">        Response result = reDrawBackMoney.getBody();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        return result.getStatus() == 1;</span>
    }

    public static HttpHeaders getAuthorizationHeadersFrom(HttpHeaders oldHeaders) {
<span class="nc" id="L469">        HttpHeaders newHeaders = new HttpHeaders();</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (oldHeaders.containsKey(HttpHeaders.AUTHORIZATION)) {</span>
<span class="nc" id="L471">            newHeaders.add(HttpHeaders.AUTHORIZATION, oldHeaders.getFirst(HttpHeaders.AUTHORIZATION));</span>
        }
<span class="nc" id="L473">        return newHeaders;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>